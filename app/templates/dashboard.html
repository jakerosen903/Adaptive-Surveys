{% extends "base.html" %}

{% block title %}Dashboard - Adaptive Survey System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>Survey Dashboard</h1>
        <p class="lead">Manage your adaptive surveys and view response insights.</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('main.create_survey') }}" class="btn btn-primary">Create New Survey</a>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <!-- Survey Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Active Surveys</h5>
                        <h2 class="card-text">{{ active_surveys_count }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Responses</h5>
                        <h2 class="card-text">{{ total_responses_count }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">Generated Insights</h5>
                        <h2 class="card-text">{{ total_insights_count }}</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Surveys Table -->
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="surveyTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button" role="tab">Active Surveys</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab">Completed Surveys</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="surveyTabContent">
                    <div class="tab-pane fade show active" id="active" role="tabpanel">
                        {% if active_surveys %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Main Question</th>
                                            <th>Created</th>
                                            <th>Responses</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for survey in active_surveys %}
                                            <tr>
                                                <td>{{ survey.title }}</td>
                                                <td>{{ survey.main_question }}</td>
                                                <td>{{ survey.created_at.strftime('%Y-%m-%d') }}</td>
                                                <td>{{ survey.responses.count() }}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <a href="{{ url_for('main.view_survey', survey_id=survey.id) }}" class="btn btn-outline-primary">View</a>
                                                        <a href="{{ url_for('main.survey_insights', survey_id=survey.id) }}" class="btn btn-outline-info">Insights</a>
                                                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">More</button>
                                                        <ul class="dropdown-menu">
                                                            <li><a class="dropdown-item" href="{{ url_for('main.edit_survey', survey_id=survey.id) }}">Edit</a></li>
                                                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#shareSurveyModal" data-survey-id="{{ survey.id }}" data-survey-title="{{ survey.title }}">Share</a></li>
                                                            <li><hr class="dropdown-divider"></li>
                                                            <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deactivateSurveyModal" data-survey-id="{{ survey.id }}" data-survey-title="{{ survey.title }}">Deactivate</a></li>
                                                        </ul>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                You don't have any active surveys. <a href="{{ url_for('main.create_survey') }}">Create one now</a>.
                            </div>
                        {% endif %}
                    </div>
                    <div class="tab-pane fade" id="completed" role="tabpanel">
                        {% if completed_surveys %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Main Question</th>
                                            <th>Completed</th>
                                            <th>Total Responses</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for survey in completed_surveys %}
                                            <tr>
                                                <td>{{ survey.title }}</td>
                                                <td>{{ survey.main_question }}</td>
                                                <td>{{ survey.completed_at.strftime('%Y-%m-%d') }}</td>
                                                <td>{{ survey.responses.count() }}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <a href="{{ url_for('main.survey_insights', survey_id=survey.id) }}" class="btn btn-outline-info">Insights</a>
                                                        <a href="{{ url_for('main.export_survey_data', survey_id=survey.id) }}" class="btn btn-outline-secondary">Export Data</a>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                You don't have any completed surveys yet.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Survey Modal -->
<div class="modal fade" id="shareSurveyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Survey</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Share this link with your respondents:</p>
                <div class="input-group mb-3">
                    <input type="text" id="surveyShareLink" class="form-control" readonly>
                    <button class="btn btn-outline-secondary" type="button" id="copyLinkBtn">Copy</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Deactivate Survey Modal -->
<div class="modal fade" id="deactivateSurveyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Deactivate Survey</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to deactivate "<span id="deactivateSurveyTitle"></span>"?</p>
                <p>This will prevent new responses but preserve all existing data.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deactivateSurveyForm">
                    <input type="hidden" name="survey_id" id="deactivateSurveyId">
                    <button type="submit" class="btn btn-danger">Deactivate</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Handle Share Modal
    const shareSurveyModal = document.getElementById('shareSurveyModal');
    if (shareSurveyModal) {
        shareSurveyModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const surveyId = button.getAttribute('data-survey-id');
            const shareUrl = `${window.location.origin}/survey/${surveyId}`;
            document.getElementById('surveyShareLink').value = shareUrl;
        });

        // Copy link button
        document.getElementById('copyLinkBtn').addEventListener('click', function() {
            const surveyShareLink = document.getElementById('surveyShareLink');
            surveyShareLink.select();
            document.execCommand('copy');
            this.innerHTML = 'Copied!';
            setTimeout(() => {
                this.innerHTML = 'Copy';
            }, 2000);
        });
    }

    // Handle Deactivate Modal
    const deactivateSurveyModal = document.getElementById('deactivateSurveyModal');
    if (deactivateSurveyModal) {
        deactivateSurveyModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const surveyId = button.getAttribute('data-survey-id');
            const surveyTitle = button.getAttribute('data-survey-title');

            document.getElementById('deactivateSurveyTitle').textContent = surveyTitle;
            document.getElementById('deactivateSurveyId').value = surveyId;

            const deactivateForm = document.getElementById('deactivateSurveyForm');
            deactivateForm.action = `/survey/${surveyId}/deactivate`;
        });
    }
</script>
{% endblock %}
